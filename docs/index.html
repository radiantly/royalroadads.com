<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Royal Road Ads</title>
    <style>
      :root {
        --grid-padding: 10px;
        --rr-blue: #337ab7;
      }
      * {
        box-sizing: border-box;
      }
      html,
      body {
        margin: 0;
        min-height: 100vh;
      }
      body {
        display: flex;
        justify-content: center;
        color: #111;
        background-color: #fff;
        font-family: -apple-system, BlinkMacSystemFont, avenir next, avenir,
          segoe ui, helvetica neue, Adwaita Sans, Cantarell, Ubuntu, roboto,
          noto, helvetica, arial, sans-serif;
        overflow-x: hidden;
      }

      .text {
        font-size: 14px;
        line-height: 1.4;
      }
      .text a {
        color: inherit;
        text-decoration: none;
        position: relative;
      }

      .text a:hover {
        color: var(--rr-blue);
      }

      .text a::after {
        content: "";
        position: absolute;
        top: 100%;
        left: 0;
        width: 100%;
        height: 2px;
        background-color: var(--rr-blue);
        pointer-events: none;
        transition: all 0.2s ease;
        z-index: -1;
        transform-origin: right center;
      }

      .text a:hover::after {
        transform: scaleX(0);
      }

      .container {
        display: flex;
        flex-direction: column;
        padding: 20px;
        gap: 40px;
        width: 100%;
      }

      section {
        display: none;
      }

      nav {
        display: flex;
        padding: 20px 25px;
        position: relative;
        justify-content: center;
        z-index: 42;
        font-family: "Dot Matrix";
        border: 1px solid #ebebeb;
        width: 90vw;
        align-self: center;
        border-radius: 10px;
        box-shadow: 0 50px 110px 0 rgba(0, 0, 0, 0.1),
          0 201px 201px 0 rgba(0, 0, 0, 0.09),
          0 452px 250px 0 rgba(0, 0, 0, 0.05),
          0 803px 250px 0 rgba(0, 0, 0, 0.01);
        align-items: center;
        font-size: 1.1rem;
      }
      nav .logo {
        font-size: 24px;
      }

      nav .logo .accent {
        position: relative;
        color: white;
      }

      nav .logo .accent::before {
        content: "";
        position: absolute;
        top: -4px;
        left: -7px;
        width: calc(100% + 10px);
        height: calc(100% + 7px);
        border-radius: 5px;
        background-color: #2a2a2a;
        z-index: -1;
      }

      nav a {
        text-decoration: none;
        color: inherit;
        position: relative;
      }

      nav a::before {
        content: "";
        position: absolute;
        bottom: -4px;
        left: 0;
        width: 100%;
        height: 2px;
        background-color: #2a2a2a;
        transform: scaleX(0);
        transform-origin: left center;
        transition: transform 0.2s ease;
      }

      nav a:hover::before {
        transform: scale(1);
      }

      .rra-grid {
        --x: 0;
        --y: 0;
        --width: 300px;
        --height: 250px;

        display: flex;
        flex-grow: 1;
        gap: var(--grid-padding);
        min-height: 500vh;
        position: relative;
        align-self: stretch;
        align-items: stretch;
      }

      .rra-grid div.backdrop-container {
        filter: blur(15px);
        z-index: -1;
        contain: strict;
        flex-grow: 1;
      }

      .rra-grid div.backdrop-container img {
        position: absolute;
        top: 0;
        left: 0;
        border-radius: 10px;
        opacity: 0.7;

        width: var(--width);
        height: var(--height);
        transform: translate(var(--x), var(--y));
      }

      .rra-grid div.backdrop-container img.expanded {
        display: none;
      }

      .rra-grid div.positioned {
        position: absolute;
        top: 0;
        left: 0;

        width: var(--width);
        height: var(--height);
        transform: translate(var(--x), var(--y));
        transition: transform 0.2s ease, box-shadow 2s ease 0.2s,
          border 0.2s ease 0.2s;

        border: 1px solid transparent;

        display: flex;
        gap: 20px;
        z-index: 13;
        border-radius: 10px;
        contain: strict;
      }

      .rra-grid div.positioned:not(.expanded):hover {
        transform: translate(var(--x), calc(var(--y) - 5px));
      }

      .rra-grid div.positioned > .left {
        display: flex;
        flex-direction: column;
        gap: 20px;
      }

      .rra-grid div.positioned > .right > *,
      .rra-grid div.positioned > .left > * {
        flex-shrink: 0;
      }

      .rra-grid div.positioned > .left .cover-wrap {
        display: flex;
        position: relative;
        overflow: hidden;
        box-shadow: rgba(0, 0, 0, 0.7) 0px 15px 20px -10px;
        border-radius: 3px 2px 2px 3px;
      }

      .rra-grid div.positioned > .left .cover-wrap::before {
        content: "";
        background: linear-gradient(
          to right,
          rgba(0, 0, 0, 0.5) 2px,
          rgba(255, 255, 255, 0.2) 3px,
          rgba(255, 255, 255, 0.1) 5px,
          transparent 6px 7px,
          rgba(255, 255, 255, 0.1) 8px,
          transparent 12px
        );
        box-shadow: inset -1px 1px 2px rgba(255, 255, 255, 0.3);
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
      }

      .rra-grid div.positioned > .left .cover-wrap img {
        width: 150px;
        height: 225px;
      }

      .rra-grid div.positioned > .left .read-btn {
        display: flex;
        justify-content: center;
        align-items: center;
        text-decoration: none;
        border: none;
        background-color: var(--rr-blue);
        height: 40px;
        color: white;
        font-size: 16px;
        font-weight: 600;
        transition: background-color 0.2s ease;
      }

      .rra-grid div.positioned > .left .read-btn:hover {
        background-color: #2a6ea8;
      }

      .rra-grid div.positioned > .left .ad-wrap {
        border-radius: 10px;
        display: flex;
        position: relative;
      }

      .rra-grid div.positioned:not(.external) > .left .ad-wrap {
        cursor: default;
      }

      .rra-grid div.positioned > .left .ad-wrap img {
        border-radius: 10px;
      }

      .rra-grid div.positioned > .left .ad-wrap > .open-in-new-icon-wrap {
        width: 24px;
        height: 24px;
        display: flex;
        justify-content: center;
        align-items: center;
        position: absolute;
        top: 10px;
        right: 10px;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.2s ease;
      }

      .rra-grid div.positioned > .left .ad-wrap > .open-in-new-icon-wrap {
        fill: #fefefe;
        filter: drop-shadow(0 0 5px black);
      }

      .rra-grid
        div.positioned.external
        > .left
        .ad-wrap:hover
        > .open-in-new-icon-wrap {
        opacity: 1;
      }

      .rra-grid div.positioned > .right {
        display: flex;
        flex-direction: column;
        min-width: 0;
        gap: 10px;
      }

      .rra-grid div.positioned > .right .title-row {
        display: flex;
        opacity: 0;
        animation: fade-in 0.2s ease 0.3s forwards;
      }

      .rra-grid div.positioned > .right .title {
        font-family: "Dot Matrix";
        font-size: 22px;
      }

      .rra-grid div.positioned > .right .close {
        cursor: pointer;
        position: relative;
      }

      .rra-grid div.positioned > .right .close::before {
        content: "";
        position: absolute;
        top: -10px;
        left: -10px;
        width: calc(100% + 20px);
        height: calc(100% + 20px);
        opacity: 0.2;
      }

      .rra-grid div.positioned > .right .close svg {
        fill: #ddd;
        transition: fill 0.2s ease;
      }

      .rra-grid div.positioned > .right .close:hover svg {
        fill: #aaa;
      }

      .rra-grid div.positioned > .right .info {
        --tag-height: 20px;
        height: var(--tag-height);
        opacity: 0;
        animation: fade-in 0.2s ease 0.4s forwards;
      }

      .rra-grid div.positioned > .right .info > .info-children {
        display: flex;
        flex-direction: column;
        gap: 10px;
        clip-path: polygon(
          0 0,
          100% 0,
          100% var(--tag-height),
          0 var(--tag-height)
        );
        transition: clip-path 0.4s ease;
      }

      .rra-grid div.positioned > .right .tags {
        display: flex;
        gap: 5px;
        flex-wrap: wrap;
        font-size: 13px;
        text-transform: capitalize;
        color: #666;
      }
      .rra-grid div.positioned > .right .info:hover > .info-children {
        clip-path: polygon(0 0, 100% 0, 100% 100%, 0 100%);
      }

      .rra-grid div.positioned > .right .tags > div {
        flex-shrink: 0;
        border: 1px solid #ddd;
        border-radius: 2px;
        padding: 0 3px;
        height: var(--tag-height);
        display: flex;
        align-items: center;
      }

      .rra-grid div.positioned > .right .byline {
        font-style: italic;
      }

      .rra-grid div.positioned > .right .summary {
        opacity: 0;
        animation: fade-in 0.3s ease 0.5s forwards;
        display: flex;
        flex-direction: column;
        gap: 10px;
        clip-path: inset(0 0 0 0);
        transition: clip-path 0.5s ease;
      }

      .rra-grid div.positioned > .right .info:hover + .summary {
        clip-path: inset(100% 0 0 0);
      }

      .rra-grid div.positioned > .right .summary > p {
        margin: 0;
      }

      .rra-grid div.positioned > .right hr {
        border: none;
        background-color: #ddd;
        height: 2px;
      }

      .rra-grid div.positioned:not(.expanded) .left .cover-wrap,
      .rra-grid div.positioned:not(.expanded) .left .read-btn,
      .rra-grid div.positioned:not(.expanded) .right {
        display: none;
      }

      .rra-grid div.positioned:not(.expanded) .left,
      .rra-grid div.positioned:not(.expanded) .left .ad-wrap {
        flex-grow: 1;
      }

      .rra-grid div.positioned.expanded {
        box-shadow: 0 22px 48px 0 rgba(0, 0, 0, 0.1),
          0 87px 87px 0 rgba(0, 0, 0, 0.09), 0 196px 118px 0 rgba(0, 0, 0, 0.05),
          0 348px 139px 0 rgba(0, 0, 0, 0.01), 0 545px 152px 0 rgba(0, 0, 0, 0);
        border: 1px solid #ebebeb;
        padding: 20px;
      }

      .rra-grid div.positioned.expanded .ad-wrap img {
        width: 150px;
        height: 125px;
        border-radius: 0;
      }

      @media screen and (max-width: 600px) {
        html {
          scroll-snap-type: y mandatory;
        }
        body {
          flex-direction: column;
          justify-content: start;
        }
        .container {
          display: none;
        }
        section {
          display: flex;
          flex-direction: column;
          min-height: 0;
          contain: strict;
          align-items: center;
          gap: 20px;

          --ad-width: min(95vw, 300px);

          padding: 1rem;
          height: 100vh;
          scroll-snap-align: start;
          position: relative;
          padding: max(20px, 5vh) 0;
        }
        section:nth-child(odd) {
          background-color: #fefefe;
        }
        .m-rect-ad {
          width: var(--ad-width);
          height: 250px;
          border-radius: 10px;
        }
        .m-infobox {
          --padding: 15px;
          width: var(--ad-width);
          display: flex;
          flex-direction: column;
          align-items: stretch;
          gap: 20px;

          background-color: #eee;
          border-radius: 10px;
          overflow: hidden;
          padding-bottom: var(--padding);
          position: relative;
          flex-grow: 1;
        }
        .m-infobox::after {
          content: "";
          position: absolute;
          bottom: 0;
          left: 0;
          width: 100%;
          height: 40px;
          z-index: 13;
          background: linear-gradient(to bottom, transparent, #eee 20px);
        }
        .m-title {
          font-family: "Dot Matrix";
          background-color: #3d3d3d;
          display: flex;
          font-size: 20px;
          padding: 10px var(--padding);
          color: #f3f3f3;
          line-height: 1.4;
        }
        .m-cover-row {
          display: flex;
          padding: 0 var(--padding);
          gap: 10px;
          min-height: 0;
          flex-shrink: 0;
          height: 150px;
        }
        img.m-cover {
          height: 150px;
          width: 100px;
        }
        .m-tags-n-stuff {
          display: flex;
          flex-direction: column;
          flex-grow: 1;
          min-height: 0;
          gap: 4px;
        }
        .m-tags-wrap {
          flex-grow: 1;
          display: flex;
          flex-direction: column;
          min-height: 0;
          overflow: hidden;
        }
        .m-tags {
          display: flex;
          flex-wrap: wrap;
          gap: 4px;
          text-transform: capitalize;
          align-items: flex-start;
          color: #444;
          font-size: 13px;
        }
        .m-tags > div {
          height: 19px;
          flex-shrink: 0;
          border: 1px solid #ddd;
          border-radius: 2px;
          padding: 0 3px;
          display: flex;
          align-items: center;
        }
        .m-button-row {
          display: flex;
          gap: 10px;
          height: 34px;
          align-items: stretch;
          flex-shrink: 0;
        }
        a.m-read-btn {
          background-color: var(--rr-blue);
          display: flex;
          color: white;
          flex-grow: 1;
          align-items: center;
          font-size: 14px;
          text-decoration: none;
        }
        .m-read-btn > span {
          text-align: center;
          flex-grow: 1;
        }
        .m-read-btn > svg {
          fill: white;
          margin: 0 10px;
        }
        .m-app-btn {
          display: flex;
          align-items: center;
          padding: 0 5px;
        }
        .m-desc {
          /* color: white; */
          padding: 0 var(--padding);
          display: flex;
          flex-direction: column;
          gap: 10px;
          min-height: 0;
          overflow: hidden;
          flex-shrink: 0;
        }
        .m-desc > p {
          margin: 0;
        }
      }

      @keyframes fade-in {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <nav>
        <div class="logo">Royal Road <span class="accent">Ads</span></div>
        <div style="flex-grow: 1"></div>
        <div class="github">
          <a
            href="https://github.com/radiantly/royalroadads.com"
            target="_blank"
            >GITHUB</a
          >
        </div>
      </nav>
      <div class="rra-grid">
        <div class="backdrop-container"></div>
      </div>
    </div>
    <section>
      <h1>Royal Road Ads</h1>
    </section>
    <template id="ad-element">
      <div class="positioned">
        <div class="left">
          <div class="cover-wrap">
            <img src="#" />
          </div>
          <a href="#" class="read-btn" target="_blank">Read now</a>
          <a href="#" class="ad-wrap" target="_blank">
            <img
              src="data:image/webp;base64,UklGRsAAAABXRUJQVlA4ILQAAACQEwCdASosAfoAPpFIoU0lpCMiICgAsBIJaW7hd2EbQAnsA99snIe+2TkPfbJyHvtk5D32ych77ZOQ99snIe+2TkPfbJyHvtk5D32ych77ZOQ99snIe+2TkPfbJyHvtk5D32ych77ZOQ99snIe+2TkPfbJyHvtk5D32ych77ZOQ99snIe+2TkPfbJyHvtk5D32ych77ZOQ99snIe+2TkPfbJyHrAAA/v/SegAAAAAAAAAAAAA="
            />
            <div class="open-in-new-icon-wrap">
              <svg
                width="18"
                height="18"
                viewBox="0 0 18 18"
                xmlns="http://www.w3.org/2000/svg"
              >
                <path
                  d="M15 16H3C2.45 16 2 15.55 2 15V3C2 2.45 2.45 2 3 2H8C8.55 2 9 1.55 9 1C9 0.45 8.55 0 8 0H2C0.89 0 0 0.9 0 2V16C0 17.1 0.9 18 2 18H16C17.1 18 18 17.1 18 16V10C18 9.45 17.55 9 17 9C16.45 9 16 9.45 16 10V15C16 15.55 15.55 16 15 16ZM11 1C11 1.55 11.45 2 12 2H14.59L5.46 11.13C5.07 11.52 5.07 12.15 5.46 12.54C5.85 12.93 6.48 12.93 6.87 12.54L16 3.41V6C16 6.55 16.45 7 17 7C17.55 7 18 6.55 18 6V1C18 0.45 17.55 0 17 0H12C11.45 0 11 0.45 11 1Z"
                />
              </svg>
            </div>
          </a>
        </div>
        <div class="right">
          <div class="title-row">
            <div class="title"></div>
            <div style="flex-grow: 1"></div>
            <div class="close">
              <svg
                width="12"
                height="12"
                viewBox="0 0 12 12"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
              >
                <path
                  d="M10.6904 0.0498047C11.0503 0.0498316 11.3431 0.16568 11.5732 0.394531C11.8249 0.646282 11.9502 0.943156 11.9502 1.28809C11.9502 1.5899 11.8547 1.84645 11.6631 2.05957L11.5732 2.14941L7.75781 5.93164L7.72266 5.96777L7.75781 6.00293L11.5732 9.80762C11.802 10.0378 11.917 10.3306 11.917 10.6904C11.917 11.0055 11.8289 11.2691 11.6533 11.4844L11.5732 11.5732C11.3215 11.825 11.0246 11.9501 10.6797 11.9502C10.3348 11.9502 10.0488 11.8255 9.81934 11.5752L9.81836 11.5732L6.03516 7.75781L6 7.72266L5.96484 7.75781L2.16016 11.5732C1.93001 11.8021 1.63711 11.9169 1.27734 11.917C0.917444 11.917 0.623764 11.8021 0.393555 11.5732H0.394531C0.165694 11.3444 0.0498047 11.053 0.0498047 10.6953C0.0498776 10.3378 0.165766 10.0471 0.394531 9.81836L4.20898 6.00293L4.24512 5.9668L4.20898 5.93164L0.393555 2.16016H0.394531C0.165706 1.92998 0.0498595 1.63713 0.0498047 1.27734C0.0498047 0.917476 0.165723 0.624724 0.394531 0.394531C0.623314 0.165748 0.913942 0.0498594 1.27148 0.0498047C1.62914 0.0498047 1.92058 0.165694 2.14941 0.394531L5.96484 4.20898L6 4.24512L6.03516 4.20898L9.80762 0.394531C10.0378 0.165678 10.3306 0.0498047 10.6904 0.0498047Z"
                />
              </svg>
            </div>
          </div>
          <div class="info">
            <div class="info-children">
              <div class="tags"></div>
              <div class="byline text">
                <span class="status"></span>&nbsp;<span class="type"></span
                >&nbsp;by&nbsp;<a href="#" class="author" target="_blank"></a>.
              </div>
              <div class="retrieved-on text"></div>
            </div>
          </div>
          <div class="summary text"></div>
        </div>
      </div>
      <img class="backdrop" src="#" aria-hidden="true" />
    </template>
    <template id="m-ad-element">
      <section>
        <img
          class="m-rect-ad"
          src="300x250/19d467f0-ec4f-4ad1-99a8-2b1568ec452b.webp"
        />
        <div class="m-infobox">
          <div class="m-title">Royal Road Ad</div>
          <div class="m-cover-row">
            <img src="200x300/95818.webp" alt="Cover image" class="m-cover" />
            <div class="m-tags-n-stuff">
              <div class="m-tags-wrap">
                <div class="m-tags"></div>
              </div>
              <div class="m-button-row">
                <a href="#" target="_blank" class="m-read-btn">
                  <span>Read now</span>
                  <svg
                    width="14"
                    height="14"
                    viewBox="0 0 18 18"
                    xmlns="http://www.w3.org/2000/svg"
                  >
                    <path
                      d="M15 16H3C2.45 16 2 15.55 2 15V3C2 2.45 2.45 2 3 2H8C8.55 2 9 1.55 9 1C9 0.45 8.55 0 8 0H2C0.89 0 0 0.9 0 2V16C0 17.1 0.9 18 2 18H16C17.1 18 18 17.1 18 16V10C18 9.45 17.55 9 17 9C16.45 9 16 9.45 16 10V15C16 15.55 15.55 16 15 16ZM11 1C11 1.55 11.45 2 12 2H14.59L5.46 11.13C5.07 11.52 5.07 12.15 5.46 12.54C5.85 12.93 6.48 12.93 6.87 12.54L16 3.41V6C16 6.55 16.45 7 17 7C17.55 7 18 6.55 18 6V1C18 0.45 17.55 0 17 0H12C11.45 0 11 0.45 11 1Z"
                    />
                  </svg>
                </a>
                <a href="#" target="_blank" class="m-app-btn">
                  <svg
                    class="m-google-play-icon"
                    width="14"
                    height="15"
                    viewBox="0 0 14 15"
                    fill="none"
                    xmlns="http://www.w3.org/2000/svg"
                  >
                    <path
                      d="M6.53819 7.15088L0.0581055 13.731C0.130876 13.981 0.261648 14.2115 0.440423 14.4049C0.619198 14.5984 0.841244 14.7497 1.08959 14.8472C1.33793 14.9447 1.606 14.9859 1.87329 14.9677C2.14059 14.9494 2.40004 14.8722 2.63181 14.7418L9.92313 10.7171L6.53819 7.15088Z"
                      fill="#EA4335"
                    />
                    <path
                      d="M13.0908 6.03262L9.93778 4.28223L6.38867 7.30078L9.95222 10.7078L13.0812 8.97622C13.3584 8.83554 13.5906 8.62402 13.7526 8.36457C13.9146 8.10512 14.0002 7.80765 14.0002 7.50439C14.0002 7.20113 13.9146 6.90366 13.7526 6.64421C13.5906 6.38476 13.3584 6.17324 13.0812 6.03256L13.0908 6.03262Z"
                      fill="#FBBC04"
                    />
                    <path
                      d="M0.0579857 1.24512C0.01884 1.38547 -0.000657598 1.53028 1.69184e-05 1.67566V13.3008C0.000403454 13.4461 0.019883 13.5908 0.0579857 13.7314L6.76021 7.31975L0.0579857 1.24512Z"
                      fill="#4285F4"
                    />
                    <path
                      d="M6.58648 7.48802L9.93762 4.28221L2.65598 0.238678C2.38201 0.0831767 2.07042 0.000822915 1.75293 3.25072e-06C0.965043 -0.00148085 0.272371 0.505339 0.0581055 1.24023L6.58648 7.48802Z"
                      fill="#34A853"
                    />
                  </svg>
                </a>
              </div>
            </div>
          </div>
          <div class="m-desc text">We don't have details for this one</div>
        </div>
      </section>
    </template>
    <script src="https://cdn.jsdelivr.net/npm/gsap@3.13.0/dist/gsap.min.js"></script>
    <script>
      class FictionBuddy {
        static TAGS = Object.freeze({
          fanfic: "Fan Fiction",
          gamelit: "GameLit",
          litrpg: "LitRPG",
          multiple_lead: "Multiple Lead Characters",
          summoned_hero: "Portal Fantasy / Isekai",
        });

        static #dataPromise;
        static #cache = {};
        static {
          setTimeout(() => {
            this.#dataPromise = fetch("fiction.json")
              .then((response) => response.json())
              .then((obj) => obj?.entries ?? {});
          }, 0);
        }

        static #fixupFictionResponse(id, fiction) {
          fiction.id = id;
          fiction.tags = fiction.tags.map(
            (tag) => this.TAGS[tag] ?? tag.replace(/_/g, " ")
          );
          return fiction;
        }

        static getFictionDetails(fictionId) {
          if (this.#cache.hasOwnProperty(fictionId))
            return this.#cache[fictionId];

          return (this.#cache[fictionId] = this.#dataPromise.then((details) => {
            if (details.hasOwnProperty(fictionId))
              return this.#fixupFictionResponse(fictionId, details[fictionId]);
            return null;
          }));
        }

        static getFictionDetailsFromLink(link) {
          const match = link.match(/royalroad\.com\/fiction\/(\d+)/);
          if (!match) return new Promise((resolve) => resolve(null));
          return FictionBuddy.getFictionDetails(match[1]);
        }
      }

      class RectangleAd {
        static WIDTH = 300;
        static HEIGHT = 250;
        static MIN_WIDTH_EXPANDED = 600;

        #state;
        #current;
        #required;
        constructor(requestLayoutCallback) {
          this.#state = {
            requestLayoutCallback,

            // elements
            desktopElems: null,
            mobileElems: null,

            force_content_update: false,
          };

          this.#current = {
            // layout
            x: null,
            y: null,
            width: null,
            height: null,
            expanded: false,
            type: null,

            // content
            uid: null,
            alt: null,
            link: null,
            timestamp: null,
            fiction: null,
          };

          this.#required = Object.assign({}, this.#current);
        }

        setContent({ uid, alt, link, timestamp }) {
          /* Assumption: this function is called only once */

          this.#required.uid = uid;
          this.#required.alt = alt;
          this.#required.link = link;
          this.#required.timestamp = timestamp;

          FictionBuddy.getFictionDetailsFromLink(link).then((details) => {
            if (details === null) return;

            this.#required.fiction = details;
            this.updateContent();
          });
        }

        get width() {
          return this.#required.width;
        }
        get height() {
          return this.#required.height;
        }

        get expanded() {
          return this.#required.expanded;
        }

        get elements() {
          if (this.#state.elements === null) this.#state.elements = {};

          if (
            this.#required.type === "desktop" &&
            !this.#state.elements.positioned
          ) {
          } else if (
            this.#required.type === "mobile" &&
            !this.#state.elements.section
          ) {
          }

          return this.#state.elements;
        }

        get needsLayoutUpdate() {
          // HTML elements need to be created/updated
          if (this.#current.type !== this.#required.type) return true;

          // no manual layout required for mobile
          if (this.#current.type === "mobile") return false;

          // desktop
          return (
            this.#current.x !== this.#required.x ||
            this.#current.y !== this.#required.y ||
            this.#current.width !== this.#required.width ||
            this.#current.height !== this.#required.height ||
            this.#current.expanded !== this.#required.expanded
          );
        }

        get needsContentUpdate() {
          return (
            this.#current.uid !== this.#required.uid ||
            this.#current.alt !== this.#required.alt ||
            this.#current.link !== this.#required.link ||
            this.#current.fiction !== this.#required.fiction
          );
        }

        get expandable() {
          return this.#required.fiction !== null;
        }

        get adImgSrc() {
          console.assert(this.#required.uid !== null);
          return `300x250/${this.#required.uid}.webp`;
        }

        get coverImgSrc() {
          return `200x300/${this.#required.fiction.id}.webp`;
        }

        get authorHref() {
          return `https://www.royalroad.com/profile/${
            this.#required.fiction.author_id
          }`;
        }

        get androidLink() {
          return `https://www.royalroad.com/redirects/android/fiction/${
            this.#required.fiction.id
          }`;
        }

        get fictionStatus() {
          const status = this.#required.fiction.status.toLowerCase();
          if (status === "ongoing") return "An ongoing";
          if (status === "hiatus") return "A paused";
          if (status === "inactive") return "An inactive";
          if (status === "dropped") return "An abandoned";
          if (status === "stub") return "A stubbed";
          if (status === "completed") return "A completed";
          console.log("UNKNOWN STATUS, PLEASE CONTACT DEVELOPER", status);
          return "A";
        }

        get fictionType() {
          return this.#required.fiction.tags.includes(FictionBuddy.TAGS.fanfic)
            ? "fan fiction"
            : "web novel";
        }

        get retrievedOn() {
          const format = {
            year: "numeric",
            month: "short",
            day: "numeric",
          };
          const lastUpdated = new Date(
            this.#required.fiction.timestamp * 1000
          ).toLocaleDateString(undefined, format);
          const adFetchDate = new Date(
            this.#required.timestamp * 1000
          ).toLocaleDateString(undefined, format);
          return `Last updated on ${lastUpdated}. Ad retrieved on ${adFetchDate}.`;
        }

        get hasElements() {
          return this.#getElements() !== null;
        }

        #getElements(createIfNotExists = false) {
          if (this.#required.type === null) return null;

          if (this.#required.type === "desktop") {
            if (createIfNotExists && this.#state.desktopElems === null) {
              this.#state.desktopElems = this.#createHTMLElementsForDesktop();

              const { positioned, backdrop } = this.#state.desktopElems;

              document.querySelector(".rra-grid").appendChild(positioned);
              document
                .querySelector(".rra-grid > .backdrop-container")
                .appendChild(backdrop);
            }
            return this.#state.desktopElems;
          }

          if (this.#required.type === "mobile") {
            if (createIfNotExists && this.#state.mobileElems === null) {
              this.#state.mobileElems = this.#createHTMLElementsForMobile();
              const { section } = this.#state.mobileElems;
              document.body.appendChild(section);
            }
            return this.#state.mobileElems;
          }
        }

        #addElementHandlers(element, backdrop) {
          element.addEventListener("click", (event) => {
            if (this.expandable === false) return;
            if (event.target.closest(".close")) this.#required.expanded = false;

            if (event.target.closest(".ad-wrap")) {
              event.preventDefault();
              this.#required.expanded = true;
            }

            if (this.#current.expanded !== this.#required.expanded)
              this.#state.requestLayoutCallback(this);
          });
        }

        #markPositionUpdateSuccessful() {
          this.#current.x = this.#required.x;
          this.#current.y = this.#required.y;
          this.#current.width = this.#required.width;
          this.#current.height = this.#required.height;
          this.#current.expanded = this.#required.expanded;
          this.#current.type = this.#required.type;
        }

        #markContentUpdateSuccessful() {
          this.#current.uid = this.#required.uid;
          this.#current.alt = this.#required.alt;
          this.#current.link = this.#required.link;
          this.#current.fiction = this.#required.fiction;
        }

        #createHTMLElementsForDesktop() {
          const template = document.getElementById("ad-element");
          const fragment = template.content.cloneNode(true);
          const positioned = fragment.querySelector("div.positioned");

          const backdrop = fragment.querySelector("img.backdrop");

          this.#addElementHandlers(positioned, backdrop);

          return { positioned, backdrop };
        }

        #createHTMLElementsForMobile() {
          const template = document.getElementById("m-ad-element");
          const fragment = template.content.cloneNode(true);
          const section = fragment.querySelector("section");

          return { section };
        }

        computeHeight({ width }) {
          if (!this.#required.expanded) return RectangleAd.HEIGHT;
          // if (!this.#/) TODO: cache

          const { positioned } = this.#getElements(true);

          // set required properties
          positioned.classList.add("expanded");
          positioned.style.contain = "none";
          positioned.style.setProperty("--width", `${width}px`);
          positioned.style.setProperty("--height", `auto`);

          this.updateContent();

          // calculate height
          const { height } = positioned.getBoundingClientRect();

          // reset properties
          positioned.style.setProperty("--width", `${this.#current.width}px`);
          positioned.style.setProperty("--height", `${this.#current.height}px`);
          positioned.classList.toggle("expanded", this.#current.expanded);
          positioned.style.contain = null;

          return Math.ceil(height);
        }

        setLayoutProps({ x, y, width, height, expanded, type }) {
          this.#required.x = x ?? this.#required.x;
          this.#required.y = y ?? this.#required.y;
          this.#required.width = width ?? this.#required.width;
          this.#required.height = height ?? this.#required.height;
          this.#required.expanded = expanded ?? this.#required.expanded;

          if (type && this.#required.type !== type) {
            this.#required.type = type;
            this.#state.force_content_update = true;
          }
        }

        #updatePositionForDesktop() {
          const { x, y, width, height, expanded } = this.#required;
          const { positioned, backdrop } = this.#getElements(true);

          positioned.style.setProperty("--x", `${x}px`);
          positioned.style.setProperty("--y", `${y}px`);
          positioned.style.setProperty("--width", `${width}px`);
          positioned.style.setProperty("--height", `${height}px`);

          backdrop.style.setProperty("--x", `${x}px`);
          backdrop.style.setProperty("--y", `${y}px`);

          if (expanded !== this.#current.expanded) {
            console.log(width, height);
            positioned.classList.toggle("expanded", expanded);
            backdrop.classList.toggle("expanded", expanded);
          }

          this.#markPositionUpdateSuccessful();
        }

        #updatePositionForMobile() {
          // create elements if they don't exist
          this.#getElements(true);

          this.#current.type = this.#required.type;
        }

        updatePosition() {
          if (!this.needsLayoutUpdate) return;

          if (this.#required.type === "desktop")
            this.#updatePositionForDesktop();
          else if (this.#required.type === "mobile")
            this.#updatePositionForMobile();
        }

        #updateContentForDesktop({ positioned, backdrop }) {
          positioned.classList.toggle("external", !this.expandable);

          positioned.querySelector("a.read-btn").href = this.#required.link;
          positioned.querySelector("a.ad-wrap").href = this.#required.link;

          const img = positioned.querySelector("a.ad-wrap img");
          img.src = this.adImgSrc;
          img.alt = this.#required.alt;
          img.title = this.#required.alt;

          backdrop.src = this.adImgSrc;

          if (this.#required.fiction !== null) {
            const { title, description, tags, author_name } =
              this.#required.fiction;
            const titleElem = positioned.querySelector(".title");
            titleElem.textContent = title;

            const tagsElem = positioned.querySelector(".tags");
            const tagsElems = tags.map((tag) => {
              const div = document.createElement("div");
              div.textContent = tag;
              return div;
            });
            tagsElem.replaceChildren(...tagsElems);

            const statusElem = positioned.querySelector("span.status");
            statusElem.textContent = this.fictionStatus;

            const typeElem = positioned.querySelector("span.type");
            typeElem.textContent = this.fictionType;

            const authorElem = positioned.querySelector("a.author");
            authorElem.textContent = author_name;
            authorElem.href = this.authorHref;

            const retrievedElem = positioned.querySelector("div.retrieved-on");
            retrievedElem.textContent = this.retrievedOn;

            const summaryElem = positioned.querySelector(".summary");
            summaryElem.innerHTML = description;

            const coverImageElem = positioned.querySelector(".cover-wrap img");
            coverImageElem.src = this.coverImgSrc;
          }

          this.#markContentUpdateSuccessful();
        }

        #updateContentForMobile({ section }) {
          section.querySelector("a.m-read-btn").href = this.#required.link;

          const img = section.querySelector("img.m-rect-ad");
          img.src = this.adImgSrc;
          img.alt = this.#required.alt;
          img.title = this.#required.alt;

          if (this.#required.fiction !== null) {
            const { title, description, tags, author_name } =
              this.#required.fiction;
            const titleElem = section.querySelector(".m-title");
            titleElem.textContent = title;

            const tagsElem = section.querySelector(".m-tags");
            const tagsElems = tags.map((tag) => {
              const div = document.createElement("div");
              div.textContent = tag;
              return div;
            });
            tagsElem.replaceChildren(...tagsElems);

            const appBtnElem = section.querySelector("a.m-app-btn");
            appBtnElem.href = this.androidLink;

            const summaryElem = section.querySelector(".m-desc");
            summaryElem.innerHTML = description;

            const coverImageElem = section.querySelector("img.m-cover");
            coverImageElem.src = this.coverImgSrc;
          }

          this.#markContentUpdateSuccessful();
        }

        updateContent() {
          if (!this.needsContentUpdate && !this.#state.force_content_update)
            return;

          if (this.#required.uid === null) return;

          const elements = this.#getElements();

          if (elements === null) return;

          if (this.#required.type === "desktop")
            this.#updateContentForDesktop(elements);
          else if (this.#required.type === "mobile")
            this.#updateContentForMobile(elements);
        }
      }

      class RenderMonkey {
        #state;
        constructor() {
          this.#state = {
            ads: [],
            layoutComputedTill: { y: 0, index: 0 },
            m_index: 0,

            varianceCache: new Map(),

            placeholderEntriesCount: 0,

            layoutPending: false,
            activeAd: null,

            vWidth: null,
            vHeight: null,
            scrollY: null,
            type: this.#getLayoutType(),
          };

          this.requestRender = this.requestRender.bind(this);
        }

        #getLayoutType() {
          return window.innerWidth <= 600 ? "mobile" : "desktop";
        }

        addPlaceholderEntries(count) {
          this.#state.placeholderEntriesCount += count;
          for (let i = 0; i < count; i += 1) {
            const ad = new RectangleAd(this.requestRender);
            ad.setLayoutProps({ type: this.#state.type });
            this.#state.ads.push(ad);
          }
        }

        addAdEntries(entries) {
          for (const [uid, entry] of Object.entries(entries)) {
            if (this.#state.placeholderEntriesCount) {
              const index =
                this.#state.ads.length - this.#state.placeholderEntriesCount;
              this.#state.placeholderEntriesCount -= 1;
              this.#state.ads[index].setContent({ uid, ...entry });
            } else {
              const ad = new RectangleAd(this.requestRender);
              ad.setLayoutProps({ type: this.#state.type });
              ad.setContent({ uid, ...entry });
              this.#state.ads.push(ad);
            }
          }
        }

        #getVariances(count, variance) {
          if (!this.#state.varianceCache.has(variance))
            this.#state.varianceCache.set(variance, []);

          const variances = this.#state.varianceCache.get(variance);
          const missing = count - variances.length;
          for (let i = 0; i < missing; i += 1) {
            const vx = Math.floor(Math.random() * variance);
            const vy = Math.floor(Math.random() * variance);
            variances.push({ vx, vy });
          }
          return variances;
        }

        #calcMaxAdsForWidth(adWidth, gap, totWidth) {
          // Let x be the number of ads that can be fit in totWidth
          // adWidth * x + gap * (x - 1) = totWidth
          // adWidth * x + gap * x - gap = totWidth
          // x * (adWidth + gap) = totWidth + gap
          // x = (totWidth + gap) / (adWidth + gap)
          return Math.floor((totWidth + gap) / (adWidth + gap));
        }

        computeLayout() {
          const { vWidth, vHeight, scrollY, activeAd } = this.#state;

          if (this.#state.type === "mobile") {
            const { scrollHeight } = document.body;
            const loadCount = Math.max(
              0,
              5 - (scrollHeight - scrollY) / vHeight
            );
            this.#state.m_index = Math.min(
              this.#state.m_index + loadCount,
              this.#state.ads.length
            );
            console.log(
              scrollHeight,
              scrollY,
              vHeight,
              loadCount,
              this.#state.m_index
            );
            return;
          }

          const gap = 10;
          const variance = 40; // TODO: make this dynamic based on vWidth or perRow
          const adWidth = RectangleAd.WIDTH + variance;
          const adHeight = RectangleAd.HEIGHT + variance;

          // Ads

          const n = this.#state.ads.length;
          const variances = this.#getVariances(n, variance);

          // iterator
          const it = {
            y: 0,
            index: 0,
          };

          console.log(n, variances);
          let adsInLastRow = 0;
          let side = null;
          let lastSideOnRight = true;
          while (it.index < n) {
            let continueFlag = false;

            // if there was a side but is now over
            if (side && side.tillY < it.y) side = null;

            // don't compute layout for things that are very far from the viewport
            // TODO: this is a costly operation when the user has scrolled down
            //       and more elements are present
            if (
              side === null &&
              !this.#state.ads[it.index].hasElements &&
              it.y > scrollY + vHeight * 5
            )
              break;

            // if the ad is expanded, we want
            if (this.#state.ads[it.index].expanded) {
              console.log(it.index, "is expanded");
              const ad = this.#state.ads[it.index];
              if (side === null) {
                // calculate the available width
                const avWidth =
                  vWidth - (RectangleAd.MIN_WIDTH_EXPANDED + variance + gap);

                const adsInRow = this.#calcMaxAdsForWidth(
                  adWidth,
                  gap,
                  avWidth
                );
                const extraSpace =
                  avWidth - (adWidth * adsInRow + gap * (adsInRow - 1));

                // ead = expanded ad
                const eadWidth = RectangleAd.MIN_WIDTH_EXPANDED + extraSpace;
                const eadHeight = ad.computeHeight({ width: eadWidth });

                const { vx, vy } = variances[it.index];
                side = {
                  onRight: !lastSideOnRight,
                  width: eadWidth + variance + gap,
                  height: eadHeight + variance + gap,
                  tillY: eadHeight + vy + gap + it.y,
                  it: Object.assign({}, it),
                };
                lastSideOnRight = side.onRight;
                const x = side.onRight ? vWidth - side.width + gap + vx : vx;
                const y = vy + it.y;
                ad.setLayoutProps({
                  x,
                  y,
                  width: eadWidth,
                  height: eadHeight,
                  expanded: true,
                });
                console.log("side", side);
                it.index += 1;
              }
            }

            const avWidth = vWidth - (side?.width ?? 0); // available width
            const adsInRow = this.#calcMaxAdsForWidth(adWidth, gap, avWidth);
            const adsInThisRow = Math.max(
              side == null,
              adsInRow - (adsInRow === adsInLastRow)
            );
            adsInLastRow = adsInThisRow;
            const startX =
              Math.floor(
                (avWidth -
                  (adWidth * adsInThisRow + gap * (adsInThisRow - 1))) /
                  2
              ) + (side?.onRight === false ? side.width : 0);
            for (let j = 0; j < adsInThisRow && it.index < n; j += 1) {
              const ad = this.#state.ads[it.index];
              if (ad.expanded) {
                if (side === null) {
                  const startIndex = it.index - j;
                  [this.#state.ads[startIndex], this.#state.ads[it.index]] = [
                    ad,
                    this.#state.ads[startIndex],
                  ];
                  it.index = startIndex;
                  continueFlag = true;
                  break;
                } else {
                  const sideAd = this.#state.ads[side.it.index];
                  // confirm that the ad that's already on the side is not the active ad.
                  // active ad == ad that triggered this layout (eg, by click)
                  if (sideAd !== activeAd) {
                    sideAd.setLayoutProps({
                      expanded: false,
                    });
                    [it.y, it.index] = [side.it.y, side.it.index];
                    lastSideOnRight = !lastSideOnRight;
                    side = null;
                    continueFlag = true;
                    break;
                  }
                }
              }
              const { vx, vy } = variances[it.index];
              ad.setLayoutProps({
                x: vx + startX + j * (adWidth + gap),
                y: vy + it.y,
                width: 300,
                height: 250,
                expanded: false,
              });
              it.index += 1;
            }
            if (continueFlag) continue;

            // expand random stories
            // TODO: layout request needed when fiction is loaded. See note above
            // if (
            //   side === null &&
            //   it.index < n &&
            //   this.#state.ads[it.index].expandable
            // )
            //   this.#state.ads[it.index].setLayoutProps({
            //     expanded: true,
            //   });

            it.y += adHeight + gap;
          }

          this.#state.layoutComputedTill = it;
        }

        updatePositions() {
          const index =
            this.#state.type === "mobile"
              ? this.#state.m_index
              : this.#state.layoutComputedTill.index;
          const till = Math.min(index, this.#state.ads.length);
          for (let i = 0; i < till; i += 1) {
            const ad = this.#state.ads[i];
            ad.updatePosition();
            ad.updateContent();
          }
        }

        setLayoutType() {
          if (this.#getLayoutType() === this.#state.type) return;
          this.#state.type = this.#getLayoutType();

          console.log("setting layout type to", this.#state.type);

          for (const ad of this.#state.ads)
            ad.setLayoutProps({ type: this.#state.type });
        }

        render() {
          this.#state.vWidth = document.querySelector(".rra-grid").clientWidth;
          this.#state.vHeight = window.innerHeight;
          this.#state.scrollY = window.scrollY;
          console.info("COMPUTING LAYOUT");

          this.setLayoutType();
          this.computeLayout();
          console.log(this.#state.type, this.#state.ads.length);
          this.updatePositions();

          console.log(this.#state.layoutComputedTill);
          document.querySelector(".backdrop-container").style.height = `${
            this.#state.layoutComputedTill.y
          }px`;

          this.#state.layoutPending = false;
          this.#state.activeAd = null;
        }

        requestRender(requestingAd = null) {
          if (requestingAd) this.#state.activeAd = requestingAd;
          if (this.#state.layoutPending) return;
          this.#state.layoutPending = true;
          requestAnimationFrame(() => this.render());
        }

        requestRenderOnScroll() {
          if (
            this.#state.type === "desktop" &&
            this.#state.layoutComputedTill.y >
              window.scrollY + this.#state.vHeight * 3
          )
            return;
          if (this.#state.layoutComputedTill.index === this.#state.ads.length)
            return;
          this.requestRender();
        }
      }

      const renderMonkey = new RenderMonkey();
      renderMonkey.addPlaceholderEntries(13);
      renderMonkey.requestRender();

      const handleData = ({ entries }) => {
        renderMonkey.addAdEntries(entries);
        renderMonkey.requestRender();

        window.addEventListener("resize", () => renderMonkey.requestRender(), {
          passive: true,
        });
        window.addEventListener(
          "scroll",
          () => renderMonkey.requestRenderOnScroll(),
          { passive: true }
        );
      };

      fetch("300x250/entries.json")
        .then((response) => response.json())
        .then(handleData);
    </script>
  </body>
</html>
